# Email Verification System - Database Migration Summary

## Task 1: Set up database schema and migrations ✅

### Changes Made

#### 1. Schema Updates (`packages/db/schema.ts`)

**Users Table - Added Email Verification Fields:**

```typescript
// Email verification fields
emailVerified: boolean("email_verified").notNull().default(false),
emailVerificationToken: text("email_verification_token"),
emailVerificationExpiry: timestamp("email_verification_expiry", { withTimezone: true }),
```

**New Support Requests Table:**

```typescript
export const supportRequests = pgTable("support_requests", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: text("name").notNull(),
  email: text("email").notNull(),
  subject: text("subject").notNull(),
  description: text("description").notNull(),
  urgency: text("urgency").notNull(), // 'low', 'medium', 'high'
  category: text("category").notNull(), // 'technical', 'account', 'billing', 'other'
  status: text("status").notNull().default("open"),
  userId: integer("user_id"), // Optional
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  resolvedAt: timestamp("resolved_at", { withTimezone: true }),
});
```

**New Sales Inquiries Table:**

```typescript
export const salesInquiries = pgTable("sales_inquiries", {
  id: uuid("id").primaryKey().defaultRandom(),
  name: text("name").notNull(),
  email: text("email").notNull(),
  organization: text("organization").notNull(),
  organizationSize: text("organization_size"),
  interestedModules: jsonb("interested_modules").notNull(),
  message: text("message").notNull(),
  inquiryType: text("inquiry_type").notNull(), // 'pricing', 'demo', 'features', 'other'
  status: text("status").notNull().default("new"),
  userId: integer("user_id"), // Optional
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  contactedAt: timestamp("contacted_at", { withTimezone: true }),
});
```

**Added TypeScript Types:**

- `InsertSupportRequest` and `SupportRequest`
- `InsertSalesInquiry` and `SalesInquiry`
- Updated `insertUserSchema` to include email verification fields

#### 2. Migration Files

**`migrations/0000_spotty_doorman.sql`**

- Generated by Drizzle Kit
- Contains complete schema including new tables and columns
- Includes all foreign key constraints

**`migrations/0001_add_email_verification_indexes.sql`**

- Performance optimization indexes:
  - `idx_users_email_verification_token` - Fast token lookups
  - `idx_users_role` - System admin queries
  - `idx_support_requests_status` - Support request filtering
  - `idx_support_requests_created_at` - Support request sorting
  - `idx_sales_inquiries_status` - Sales inquiry filtering
  - `idx_sales_inquiries_created_at` - Sales inquiry sorting
- Backward compatibility: Sets `email_verified = true` for existing users

#### 3. Migration Scripts

**`scripts/run-email-verification-migration.ts`**

- Applies the index migration
- Updates existing users for backward compatibility
- Provides verification output

**`scripts/verify-email-verification-schema.ts`**

- Verifies all schema changes are applied correctly
- Checks table existence
- Validates indexes
- Reports user verification status

#### 4. Documentation

**`migrations/README.md`**

- Complete migration guide
- Running instructions
- Verification steps
- Rollback procedures

### How to Apply Migrations

#### Option 1: Using Drizzle Kit Push (Recommended)

```bash
npm run db:push
```

This will:

1. Apply all schema changes to the database
2. Create new tables
3. Add new columns to users table

Then run the index migration:

```bash
tsx scripts/run-email-verification-migration.ts
```

#### Option 2: Manual SQL Execution

Execute the SQL files in order:

1. `migrations/0000_spotty_doorman.sql`
2. `migrations/0001_add_email_verification_indexes.sql`

### Verification

After applying migrations, verify the changes:

```bash
tsx scripts/verify-email-verification-schema.ts
```

Expected output:

- ✅ All email verification columns exist in users table
- ✅ support_requests table exists
- ✅ sales_inquiries table exists
- ✅ All indexes created
- ✅ Existing users marked as verified

### Requirements Satisfied

✅ **Requirement 2.3**: Users table has email verification columns
✅ **Requirement 4.5**: Email verification expiry tracking
✅ **Requirement 10.2**: Secure token storage (hashed in database)
✅ **Support Requests**: Complete table with all required fields
✅ **Sales Inquiries**: Complete table with all required fields
✅ **Performance**: Indexes added for optimal query performance
✅ **Backward Compatibility**: Existing users can continue logging in

### Database Schema Diagram

```
users
├── id (serial, PK)
├── username (text, unique)
├── email (text, unique)
├── password (text)
├── email_verified (boolean) ← NEW
├── email_verification_token (text) ← NEW
├── email_verification_expiry (timestamp) ← NEW
└── ... (other existing fields)

support_requests ← NEW TABLE
├── id (uuid, PK)
├── name (text)
├── email (text)
├── subject (text)
├── description (text)
├── urgency (text)
├── category (text)
├── status (text)
├── user_id (integer, nullable)
├── created_at (timestamp)
└── resolved_at (timestamp, nullable)

sales_inquiries ← NEW TABLE
├── id (uuid, PK)
├── name (text)
├── email (text)
├── organization (text)
├── organization_size (text, nullable)
├── interested_modules (jsonb)
├── message (text)
├── inquiry_type (text)
├── status (text)
├── user_id (integer, nullable)
├── created_at (timestamp)
└── contacted_at (timestamp, nullable)
```

### Next Steps

With the database schema complete, you can now proceed to:

- **Task 2**: Implement email verification service
- **Task 3**: Extend SendGrid email service
- **Task 4**: Create admin notification service

### Notes

- All migrations are idempotent and safe to run multiple times
- Existing users are automatically marked as verified to maintain backward compatibility
- New users will default to `email_verified = false` and must verify their email
- The schema supports both authenticated and anonymous support/sales submissions
